---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getUser } from '../lib/auth';
import { supabase } from '../lib/supabase';

const user = await getUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/login');
}

// Get storage stats
const { data: posts } = await supabase
  .from('posts')
  .select('id, created_at')
  .order('created_at', { ascending: true });

const { data: profiles } = await supabase
  .from('profiles')
  .select('id');

// Note: Getting actual storage size requires service role access
// For now, we'll estimate based on post count
const postsCount = posts?.length || 0;
const usersCount = profiles?.length || 0;
const oldestPost = posts?.[0]?.created_at;
const newestPost = posts?.[posts.length - 1]?.created_at;

const message = Astro.url.searchParams.get('message');
const error = Astro.url.searchParams.get('error');
---

<BaseLayout title="Admin Dashboard">
  <nav slot="nav">
    <a href="/">Feed</a>
    <a href={`/profile/${user.id}`}>My Profile</a>
    <form method="post" action="/api/auth/signout" style="display: inline;">
      <button type="submit" class="btn btn-secondary">Sign Out</button>
    </form>
  </nav>

  <h1 style="margin-bottom: 20px;">Storage Management</h1>

  {message && <div class="success">{message}</div>}
  {error && <div class="error">{error}</div>}

  <div class="card">
    <h2 style="margin-bottom: 15px;">Database Statistics</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
      <div>
        <div style="font-size: 32px; font-weight: bold; color: #4A90E2;">{usersCount}</div>
        <div style="color: #666;">Family Members</div>
      </div>
      
      <div>
        <div style="font-size: 32px; font-weight: bold; color: #4A90E2;">{postsCount}</div>
        <div style="color: #666;">Total Posts</div>
      </div>
    </div>

    {oldestPost && (
      <div style="padding: 15px; background: #f9f9f9; border-radius: 6px;">
        <p style="margin-bottom: 5px;"><strong>Oldest Post:</strong> {new Date(oldestPost).toLocaleDateString()}</p>
        <p><strong>Newest Post:</strong> {newestPost ? new Date(newestPost).toLocaleDateString() : 'N/A'}</p>
      </div>
    )}
  </div>

  <div class="card">
    <h2 style="margin-bottom: 15px;">Storage Information</h2>
    
    <p style="margin-bottom: 15px; color: #666;">
      Your Supabase free tier includes:
    </p>
    
    <ul style="margin-bottom: 20px; padding-left: 20px;">
      <li style="margin-bottom: 8px;"><strong>Database:</strong> 500 MB</li>
      <li style="margin-bottom: 8px;"><strong>Storage:</strong> 1 GB (for images/videos)</li>
      <li><strong>Bandwidth:</strong> 5 GB/month</li>
    </ul>

    <p style="padding: 15px; background: #fff3cd; border-radius: 6px; color: #856404;">
      üí° <strong>Tip:</strong> Images are automatically compressed before upload. To manage storage, delete old posts or consider upgrading to Supabase Pro ($25/mo) for 8 GB database + 100 GB storage.
    </p>
  </div>

  <div class="card">
    <h2 style="margin-bottom: 15px;">Cleanup Tools</h2>
    
    <p style="margin-bottom: 20px; color: #666;">
      Use these tools carefully to manage storage space. Actions cannot be undone.
    </p>

    <form method="post" action="/api/admin/cleanup-old-posts" style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 10px;">
        <strong>Delete posts older than:</strong>
      </label>
      <div style="display: flex; gap: 10px; align-items: center;">
        <select name="months" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
          <option value="3">3 months</option>
          <option value="6">6 months</option>
          <option value="12">1 year</option>
          <option value="24">2 years</option>
        </select>
        <button type="submit" class="btn btn-secondary" onclick="return confirm('Are you sure you want to delete old posts? This cannot be undone.')">
          Delete Old Posts
        </button>
      </div>
    </form>

    <div style="padding: 15px; background: #fff3cd; border-radius: 6px; color: #856404; margin-top: 20px;">
      ‚ö†Ô∏è <strong>Warning:</strong> Cleanup operations will permanently delete posts and their associated media files. Make sure to back up any important content first.
    </div>
  </div>

  <div class="card">
    <h2 style="margin-bottom: 15px;">Monitoring</h2>
    
    <p style="color: #666; margin-bottom: 15px;">
      Check your actual storage usage in the Supabase Dashboard:
    </p>
    
    <a href="https://app.supabase.com/project/zdmyiowalhdzneftwzrb/settings/storage" 
       target="_blank" 
       class="btn" 
       style="display: inline-block;">
      Open Supabase Dashboard ‚Üí
    </a>
  </div>
</BaseLayout>
