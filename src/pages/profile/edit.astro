---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getUser } from '../../lib/auth';
import { supabase } from '../../lib/supabase';

const user = await getUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/login');
}

const { data: profile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', user.id)
  .single();

const message = Astro.url.searchParams.get('message');
const error = Astro.url.searchParams.get('error');
---

<BaseLayout title="Edit Profile">
  <nav slot="nav">
    <a href="/">Feed</a>
    <a href={`/profile/${user.id}`}>My Profile</a>
    <form method="post" action="/api/auth/signout" style="display: inline;">
      <button type="submit" class="btn btn-secondary">Sign Out</button>
    </form>
  </nav>

  <div class="card" style="max-width: 600px; margin: 0 auto;">
    <h1 style="margin-bottom: 20px;">Edit Profile</h1>
    
    {message && <div class="success">{message}</div>}
    {error && <div class="error">{error}</div>}
    
    <form method="post" action="/api/profile/update" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 20px;">
      <div>
        <label for="display_name" style="display: block; margin-bottom: 5px; font-weight: 500;">Display Name</label>
        <input type="text" id="display_name" name="display_name" value={profile?.display_name || ''} required />
      </div>
      
      <div>
        <label for="bio" style="display: block; margin-bottom: 5px; font-weight: 500;">Bio</label>
        <textarea id="bio" name="bio" rows={4}>{profile?.bio || ''}</textarea>
      </div>
      
      <div>
        <label for="avatar" style="display: block; margin-bottom: 5px; font-weight: 500;">Profile Picture</label>
        {profile?.avatar_url && (
          <div style="margin-bottom: 10px;">
            <img src={profile.avatar_url} alt="Current avatar" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;" />
          </div>
        )}
        <input type="file" id="avatar" name="avatar" accept="image/*" />
        <p style="font-size: 13px; color: #666; margin-top: 5px;">Max 5MB. Leave empty to keep current picture.</p>
      </div>
      
      <button type="submit" class="btn">Save Changes</button>
    </form>
  </div>
</BaseLayout>
